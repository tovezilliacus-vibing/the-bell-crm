// The Bell CRM — AIDA schema (Clerk userId for ownership)
// See docs/AIDA-DATA-MODEL.md for design.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ——— AIDA & shared enums ———

enum FunnelStage {
  AWARENESS
  INTEREST
  DESIRE
  ACTION
}

enum ActivityType {
  EMAIL
  CALL
  NOTE
}

enum TaskStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum LeadSource {
  INBOUND
  OUTREACH
  EVENT
  REFERRAL
  OTHER
  FORM
}

enum FormFieldType {
  text
  email
  textarea
  select
  checkbox
  hidden
}

enum DealStage {
  INITIATING
  NEEDS_DEVELOPMENT
  PROPOSAL
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

enum BillingTier {
  FREE     // 1 user
  STARTER  // 2–10 users
  GROWTH   // 11–50 users
  PAID     // legacy; treat like GROWTH
}

enum WorkspaceRole {
  ADMIN   // can manage account, invite users, set prospect key metrics
  MEMBER  // normal user
}

// ——— Workspace (multi-team, billing) ———

model Workspace {
  id        String      @id @default(cuid())
  name      String?     // e.g. "Acme Inc"
  plan      BillingTier @default(FREE)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  members   WorkspaceMember[]
  invites   WorkspaceInvite[]
  campaigns Campaign[]
  companies Company[]
  contacts  Contact[]
  deals     Deal[]
  tasks     Task[]
  activities Activity[]
  forms     Form[]

  @@map("workspaces")
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  workspaceId String
  userId      String        // Clerk user id
  role        WorkspaceRole @default(MEMBER)
  createdAt   DateTime      @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([userId])
  @@map("workspace_members")
}

model WorkspaceInvite {
  id          String   @id @default(cuid())
  workspaceId String
  email       String
  role        WorkspaceRole @default(MEMBER)
  invitedByUserId String     // Clerk user id of admin who sent invite
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, email])
  @@index([workspaceId])
  @@map("workspace_invites")
}

// ——— Core entities ———

model Campaign {
  id          String   @id @default(cuid())
  name        String
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  workspaceId String
  userId      String   // creator/owner, kept for audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  contacts  Contact[]

  @@index([workspaceId])
  @@map("campaigns")
}

model Company {
  id            String   @id @default(cuid())
  name          String
  domain        String?
  isAccount     Boolean  @default(false)
  workspaceId   String
  userId        String
  industry      String?
  sizeTurnover  String?
  sizePersonnel String?
  city          String?
  state         String?
  country       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  contacts  Contact[]
  deals     Deal[]

  @@index([workspaceId])
  @@map("companies")
}

model Contact {
  id           String       @id @default(cuid())
  firstName    String?
  lastName     String?
  name         String?
  email        String?
  phone        String?
  funnelStage  FunnelStage   @default(AWARENESS)
  campaignId   String?
  leadSource   LeadSource?
  referralFrom String?
  companyId    String?
  formId       String?      // set when created/updated from an embed form
  workspaceId  String
  userId       String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  company   Company?   @relation(fields: [companyId], references: [id], onDelete: SetNull)
  campaign  Campaign?  @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  form      Form?      @relation(fields: [formId], references: [id], onDelete: SetNull)
  deals     Deal[]
  tasks     Task[]
  activities Activity[]
  emails    Email[]
  stageHistory ContactStageHistory[]
  formSubmissions FormSubmission[]

  @@index([workspaceId])
  @@index([formId])
  @@map("contacts")
}

// For conversion metrics: log when a contact moves to a new AIDA stage
model ContactStageHistory {
  id         String       @id @default(cuid())
  contactId  String
  fromStage  FunnelStage?
  toStage    FunnelStage
  createdAt  DateTime     @default(now())

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([contactId, createdAt])
  @@index([toStage, createdAt])
  @@map("contact_stage_history")
}

// Per-user on/off for preconfigured automation recipes (recipes defined in code)
model AutomationRecipeSetting {
  id        String   @id @default(cuid())
  userId    String
  recipeId  String   // matches id in code (e.g. "nurture-awareness-7d")
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, recipeId])
  @@index([userId])
  @@map("automation_recipe_settings")
}

model ProspectFieldOption {
  id        String   @id @default(cuid())
  userId    String
  fieldType String
  value     String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, fieldType, value])
  @@map("prospect_field_options")
}

model Deal {
  id          String    @id @default(cuid())
  title       String
  value       Decimal   @db.Decimal(12, 2) @default(0)
  stage       DealStage @default(INITIATING)
  companyId   String?
  contactId   String?
  workspaceId String
  userId      String
  closedAt    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  company   Company?  @relation(fields: [companyId], references: [id], onDelete: SetNull)
  contact   Contact?  @relation(fields: [contactId], references: [id], onDelete: SetNull)
  tasks     Task[]
  activities Activity[]

  @@index([workspaceId])
  @@map("deals")
}

model Task {
  id          String     @id @default(cuid())
  title       String
  status      TaskStatus @default(PENDING)
  dueAt       DateTime?
  completedAt DateTime?
  contactId   String?
  dealId      String?
  workspaceId String
  userId      String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  contact   Contact?   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  deal      Deal?      @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@map("tasks")
}

model Activity {
  id          String       @id @default(cuid())
  type        ActivityType
  description String?      @db.Text
  occurredAt  DateTime     @default(now())
  contactId   String?
  dealId      String?
  workspaceId String
  userId      String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  contact   Contact?   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  deal      Deal?      @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@map("activities")
}

// ——— Embeddable contact forms ———

model Form {
  id              String   @id @default(cuid())
  workspaceId     String
  name            String
  description     String?  @db.Text
  publicKey       String   @unique  // used in embed URL, unauthenticated submissions
  thankYouMessage String?  @db.Text
  redirectUrl     String?  @db.Text
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  workspace   Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  fields      FormField[]
  submissions FormSubmission[]
  contacts    Contact[]

  @@index([workspaceId])
  @@index([publicKey])
  @@map("forms")
}

model FormField {
  id         String        @id @default(cuid())
  formId     String
  label      String
  name       String        // field key in submission payload
  type       FormFieldType
  required   Boolean       @default(false)
  options    Json?         // for select/checkbox: [{ value, label }]
  orderIndex Int           @default(0)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  form Form @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@map("form_fields")
}

model FormSubmission {
  id          String   @id @default(cuid())
  formId      String
  submittedAt DateTime @default(now())
  ipAddress   String?
  userAgent   String?  @db.Text
  payload     Json     // submitted field values
  contactId   String?

  form    Form     @relation(fields: [formId], references: [id], onDelete: Cascade)
  contact Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  @@index([formId])
  @@index([contactId])
  @@map("form_submissions")
}

// ——— Phase 6: Email in CRM ———

model UserEmailAccount {
  id           String   @id @default(cuid())
  userId       String
  provider     String
  email        String
  accessToken  String
  refreshToken String?
  expiresAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  emails Email[]

  @@unique([userId, provider])
  @@map("user_email_accounts")
}

model Email {
  id                String   @id @default(cuid())
  userId            String
  userEmailAccountId String?
  contactId         String?
  provider          String
  providerMessageId String
  threadId          String?
  direction         String
  fromAddress       String
  toAddresses       String
  subject           String?
  bodySnippet       String?  @db.Text
  body              String?  @db.Text
  sentAt            DateTime
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  contact          Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  userEmailAccount UserEmailAccount? @relation(fields: [userEmailAccountId], references: [id], onDelete: SetNull)

  @@unique([userId, provider, providerMessageId])
  @@map("emails")
}
